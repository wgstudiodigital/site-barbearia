<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Barbearia ‚Ä¢ Dom Du Corte</title>

  <!-- Chart.js (gr√°fico) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#101010;
      --card:#131313;
      --card2:#0f0f0f;
      --stroke:rgba(255,255,255,.08);
      --text:#fff;
      --muted:#a7a7a7;

      --accent:#d4a253;
      --good:#2ecc71;
      --bad:#ff6b6b;
      --info:#5dade2;

      --radius:16px;
    }

    *{ box-sizing:border-box; font-family: Arial, Helvetica, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    /* ===== LOGIN ===== */
    .center{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .login-card{
      width:100%;
      max-width:520px;
      background:linear-gradient(145deg, var(--panel), #0c0c0c);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 10px 45px rgba(0,0,0,.55);
    }
    .login-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      color:var(--accent);
      letter-spacing:.3px;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    label{ display:block; color:var(--muted); font-size:13px; margin-top:10px; }
    input, select{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#0d0d0d;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{ border-color: rgba(212,162,83,.45); }

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      transition:.18s ease;
    }
    .btn-primary{
      background:var(--accent);
      color:#0a0a0a;
    }
    .btn-primary:hover{ filter:brightness(1.08); transform: translateY(-1px); }

    .row{ display:flex; gap:10px; align-items:center; margin-top:12px; }

    .hidden{ display:none; }

    /* ===== APP LAYOUT ===== */
    .layout{
      display:flex;
      min-height:100vh;
    }

    .sidebar{
      width:260px;
      padding:18px;
      background:linear-gradient(145deg, #111, #0c0c0c);
      border-right:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .side-top{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-bottom:12px;
      border-bottom:1px solid var(--stroke);
    }
    .side-top .title{
      margin:0;
      font-size:16px;
      color:var(--accent);
      letter-spacing:.3px;
    }
    .side-top .user{
      font-size:13px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.admin{ border-color: rgba(93,173,226,.35); }
    .pill.barbeiro{ border-color: rgba(212,162,83,.35); }

    .side-actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:auto;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid var(--stroke);
      color:var(--muted);
    }
    .btn-ghost:hover{ border-color: rgba(212,162,83,.35); color:#fff; transform: translateY(-1px); }

    .main{
      flex:1;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .topbar h2{
      margin:0;
      font-size:18px;
      color:#fff;
    }
    .topbar small{
      color:var(--muted);
      display:block;
      margin-top:6px;
    }

    .filters{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .filters .field{
      min-width: 190px;
    }
    .filters label{ margin-top:0; }
    .filters input, .filters select{
      padding:9px 10px;
      border-radius:12px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap:12px;
    }
    .kpi{
      background: linear-gradient(145deg, var(--card), var(--card2));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px;
      transition:.18s ease;
    }
    .kpi:hover{ transform: translateY(-2px); border-color: rgba(212,162,83,.25); }
    .kpi span{
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .kpi b{
      font-size:28px;
      display:block;
      margin-top:10px;
      letter-spacing:.4px;
    }

    .c-accent{ color:var(--accent); }
    .c-good{ color:var(--good); }
    .c-bad{ color:var(--bad); }
    .c-info{ color:var(--info); }

    .panel-row{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:stretch;
    }

    .panel{
      background: linear-gradient(145deg, var(--card), var(--card2));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px;
    }
    .panel h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      font-weight:700;
    }

    /* Lista */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .ap-card{
      background:#0d0d0d;
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;
      padding:12px;
    }
    .ap-card h4{
      margin:0 0 6px 0;
      font-size:16px;
      color:var(--accent);
    }
    .ap-meta{ font-size:13px; color:var(--muted); margin-bottom:8px; }
    .ap-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .status.concluido{ background: rgba(46,204,113,.15); border-color: rgba(46,204,113,.35); color:#dff8ea; }
    .status.pendente{ background: rgba(255,255,255,.03); }

    .btn-done{
      background: var(--good);
      color:#06140c;
      border:none;
    }
    .btn-danger{
      background: transparent;
      border:1px solid rgba(255,107,107,.35);
      color:#ffd2d2;
    }
    .btn-danger:hover{
      background: rgba(255,107,107,.10);
      transform: translateY(-1px);
    }

    .empty{
      color:var(--muted);
      font-size:13px;
      padding:10px 0;
    }

    /* ===== RESPONSIVO ===== */
    @media (max-width: 980px){
      .cards{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
      .panel-row{ grid-template-columns: 1fr; }
    }

    @media (max-width: 760px){
      .layout{ flex-direction:column; }
      .sidebar{
        width:100%;
        border-right:none;
        border-bottom:1px solid var(--stroke);
        flex-direction:row;
        align-items:center;
        justify-content:space-between;
        gap:12px;
      }
      .side-actions{ margin-top:0; flex-direction:row; }
      .side-top{ border-bottom:none; padding-bottom:0; }
      .main{ padding:14px; }
      .filters{ justify-content:flex-start; }
      .filters .field{ min-width: 160px; }
    }

    @media (max-width: 420px){
      .cards{ grid-template-columns: 1fr; }
      .filters .field{ min-width: 100%; }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="view-login" class="center">
    <div class="login-card">
      <div class="login-top">
        <div class="brand">
          <h1>Painel Barbearia</h1>
          <p>Acesse com credenciais dos barbeiros</p>
        </div>
        <div class="pill">Dom Du Corte</div>
      </div>

      <label for="usuario">Nome (ex: Andre)</label>
      <input id="usuario" placeholder="Digite seu nome (Andre, Prata ou Rennan)" />

      <label for="senha">Senha</label>
      <input id="senha" type="password" placeholder="Senha" />

      <div class="row">
        <button id="btn-login" class="btn btn-primary">Entrar</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="view-panel" class="hidden">
    <div class="layout">

      <aside class="sidebar">
        <div class="side-top">
          <p class="title">Dom Du Corte ‚Ä¢ Painel</p>
          <div class="user">
            <span id="usuario-info"></span>
            <span id="role-pill" class="pill barbeiro">Barbeiro</span>
          </div>
        </div>

        <div class="side-actions">
          <button id="btn-logout" class="btn btn-ghost">Sair</button>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <h2 id="painel-title">Dashboard</h2>
            <small>Agendamentos em tempo real. Sem magia, s√≥ Firebase.</small>
          </div>

          <div class="filters">
            <div class="field">
              <label for="filtro-data">Filtrar dia</label>
              <input id="filtro-data" type="date" />
            </div>

            <div class="field hidden" id="admin-barbeiro-field">
              <label for="filtro-barbeiro">Barbeiro (Admin)</label>
              <select id="filtro-barbeiro">
                <option value="">Todos</option>
                <option value="andre">Andre</option>
                <option value="prata">Prata</option>
                <option value="rennan">Rennan</option>
              </select>
            </div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="cards">
          <div class="kpi">
            <span>üìÖ Hoje</span>
            <b id="kpi-hoje" class="c-accent">0</b>
          </div>
          <div class="kpi">
            <span>‚è≥ Pendentes</span>
            <b id="kpi-pendentes" class="c-bad">0</b>
          </div>
          <div class="kpi">
            <span>‚úÖ Conclu√≠dos</span>
            <b id="kpi-concluidos" class="c-good">0</b>
          </div>
          <div class="kpi">
            <span>üí∞ Faturamento (estimado)</span>
            <b id="kpi-faturamento" class="c-info">R$ 0</b>
          </div>
        </div>

        <!-- Gr√°fico + resumo -->
        <div class="panel-row">
          <div class="panel">
            <h3>Agendamentos ‚Ä¢ √∫ltimos 7 dias</h3>
            <canvas id="chart-week" height="120"></canvas>
          </div>
          <div class="panel">
            <h3>Resumo r√°pido</h3>
            <div class="ap-meta">Semana (7 dias): <strong id="week-total">0</strong></div>
            <div class="ap-meta">M√™s (atual): <strong id="month-total">0</strong></div>
            <div class="ap-meta">Total no banco: <strong id="all-total">0</strong></div>
            <div class="ap-meta">Faturamento m√™s (estimado): <strong id="month-rev">R$ 0</strong></div>
            <div class="ap-meta">Faturamento hoje (estimado): <strong id="today-rev">R$ 0</strong></div>
            <div class="ap-meta" style="margin-top:10px;color:var(--muted);font-size:12px">
              *Estimativa usa tabela padr√£o (ajuste no JS).
            </div>
          </div>
        </div>

        <!-- Lista -->
        <div class="panel">
          <h3>Agendamentos</h3>
          <div id="lista" class="grid"></div>
          <div id="empty" class="empty hidden">Nenhum agendamento encontrado.</div>
        </div>
      </main>

    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyDM0DEdaswHxdjcM5fGZOIg34nO464ccu8",
    authDomain: "barbearia-d5ef8.firebaseapp.com",
    databaseURL: "https://barbearia-d5ef8-default-rtdb.firebaseio.com",
    projectId: "barbearia-d5ef8",
    storageBucket: "barbearia-d5ef8.firebasestorage.app",
    messagingSenderId: "296046163984",
    appId: "1:296046163984:web:61f9ab42e8b68f1952f295"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ===== Credenciais =====
  const CRED = {
    "andre":"1111",
    "prata":"2222",
    "rennan":"3333",
    "admin":"admin000"
  };

  function normalizeName(name){
    return name.trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  }

  // ===== Tabela de pre√ßos (AJUSTE AQUI) =====
  // Se o agendamento vier com ap.servico = "corte" / "barba" / "corte_barba" ele usa isso.
  // Se vier com ap.preco, usa ap.preco.
  const PRICE = {
    corte: 35,
    barba: 20,
    corte_barba: 45
  };
  const DEFAULT_PRICE = 35;

  function getPrice(ap){
    if (typeof ap.preco === "number") return ap.preco;
    const s = (ap.servico || "").toLowerCase().replace(/\s+/g, "_");
    return PRICE[s] ?? DEFAULT_PRICE;
  }

  // ===== Elementos =====
  const viewLogin = document.getElementById("view-login");
  const viewPanel = document.getElementById("view-panel");

  const btnLogin = document.getElementById("btn-login");
  const usuarioInput = document.getElementById("usuario");
  const senhaInput = document.getElementById("senha");

  const usuarioInfo = document.getElementById("usuario-info");
  const rolePill = document.getElementById("role-pill");
  const painelTitle = document.getElementById("painel-title");
  const btnLogout = document.getElementById("btn-logout");

  const filtroData = document.getElementById("filtro-data");
  const adminField = document.getElementById("admin-barbeiro-field");
  const filtroBarbeiro = document.getElementById("filtro-barbeiro");

  const kpiHoje = document.getElementById("kpi-hoje");
  const kpiPend = document.getElementById("kpi-pendentes");
  const kpiConc = document.getElementById("kpi-concluidos");
  const kpiFat = document.getElementById("kpi-faturamento");

  const weekTotal = document.getElementById("week-total");
  const monthTotal = document.getElementById("month-total");
  const allTotal = document.getElementById("all-total");
  const monthRev = document.getElementById("month-rev");
  const todayRev = document.getElementById("today-rev");

  const lista = document.getElementById("lista");
  const empty = document.getElementById("empty");

  let currentUser = null;
  let currentListenerOff = null;

  // ===== Chart =====
  let weekChart = null;

  function formatBRL(v){
    return "R$ " + Number(v || 0).toFixed(0);
  }

  function isoToday(){
    return new Date().toISOString().split("T")[0];
  }

  function isoYearMonth(dateIso){
    return (dateIso || "").slice(0,7); // YYYY-MM
  }

  function lastNDaysLabels(n=7){
    const out = [];
    const base = new Date();
    base.setHours(0,0,0,0);
    for(let i=n-1;i>=0;i--){
      const d = new Date(base);
      d.setDate(d.getDate()-i);
      out.push(d.toISOString().split("T")[0]);
    }
    return out;
  }

  function ensureChart(labels, values){
    const ctx = document.getElementById("chart-week");
    if (!ctx) return;

    if (weekChart){
      weekChart.data.labels = labels;
      weekChart.data.datasets[0].data = values;
      weekChart.update();
      return;
    }

    weekChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Agendamentos",
          data: values,
          tension: 0.35,
          fill: true,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { ticks: { color: "#a7a7a7" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "#a7a7a7", precision: 0 }, grid: { color: "rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  // ===== Login =====
  btnLogin.onclick = () => {
    const nome = usuarioInput.value || "";
    const senha = senhaInput.value || "";
    const key = normalizeName(nome);

    if(!(key in CRED) || CRED[key] !== senha){
      alert("Credenciais inv√°lidas");
      return;
    }

    currentUser = { key, display: nome.trim(), isAdmin: key === "admin" };
    abrirPainel();
    startRealtime();
  };

  function abrirPainel(){
    viewLogin.classList.add("hidden");
    viewPanel.classList.remove("hidden");

    usuarioInfo.textContent = currentUser.display;
    rolePill.textContent = currentUser.isAdmin ? "Admin" : "Barbeiro";
    rolePill.classList.toggle("admin", currentUser.isAdmin);
    rolePill.classList.toggle("barbeiro", !currentUser.isAdmin);

    painelTitle.textContent = currentUser.isAdmin ? "Dashboard (Admin)" : `Dashboard (${currentUser.display})`;

    // filtros admin
    if (currentUser.isAdmin){
      adminField.classList.remove("hidden");
    } else {
      adminField.classList.add("hidden");
      if (filtroBarbeiro) filtroBarbeiro.value = "";
    }
  }

  btnLogout.onclick = () => {
    if (currentListenerOff) currentListenerOff();
    currentListenerOff = null;
    currentUser = null;

    lista.innerHTML = "";
    empty.classList.add("hidden");

    viewPanel.classList.add("hidden");
    viewLogin.classList.remove("hidden");
  };

  // ===== Realtime =====
  function startRealtime(){
    if (currentListenerOff) currentListenerOff();
    const agRef = ref(db, "agendamentos/");
    currentListenerOff = onValue(agRef, snap => {
      const data = snap.val() || {};
      renderAll(data);
    });
  }

  filtroData.onchange = () => {
    get(ref(db,"agendamentos/")).then(s=> renderAll(s.val() || {}));
  };

  if (filtroBarbeiro){
    filtroBarbeiro.onchange = () => {
      get(ref(db,"agendamentos/")).then(s=> renderAll(s.val() || {}));
    };
  }

  function renderAll(data){
    const arr = Object.keys(data).map(id => ({ id, ...data[id] }));

    const today = isoToday();
    const thisMonth = isoYearMonth(today);

    // ===== filtros visuais =====
    const dayFilter = filtroData.value || "";
    const barberFilter = (currentUser?.isAdmin ? (filtroBarbeiro?.value || "") : "");

    const visible = arr.filter(ap => {
      // filtro dia
      if (dayFilter && ap.data !== dayFilter) return false;

      // permiss√µes
      if (!currentUser?.isAdmin){
        return normalizeName(ap.barbeiro || "") === currentUser.key;
      }

      // admin pode filtrar barbeiro
      if (barberFilter){
        return normalizeName(ap.barbeiro || "") === normalizeName(barberFilter);
      }
      return true;
    });

    // ordena
    visible.sort((a,b)=>{
      if (a.data === b.data) return (a.hora > b.hora ? 1 : -1);
      return (a.data > b.data ? 1 : -1);
    });

    // ===== KPIs (sempre em cima do "vis√≠vel") =====
    let pend = 0, conc = 0, todayCount = 0;
    let todayRevenue = 0;
    let visibleRevenue = 0;

    for (const ap of visible){
      const st = (ap.status || "pendente").toLowerCase();
      if (st === "concluido") conc++;
      else pend++;

      const price = getPrice(ap);
      visibleRevenue += price;

      if (ap.data === today){
        todayCount++;
        todayRevenue += price;
      }
    }

    kpiHoje.textContent = String(todayCount);
    kpiPend.textContent = String(pend);
    kpiConc.textContent = String(conc);
    kpiFat.textContent = formatBRL(visibleRevenue);

    todayRev.textContent = formatBRL(todayRevenue);

    // ===== resumo global (n√£o depende do filtro do barbeiro, s√≥ do papel) =====
    const arrForRole = currentUser?.isAdmin ? arr : arr.filter(ap => normalizeName(ap.barbeiro||"") === currentUser.key);

    const last7 = lastNDaysLabels(7);
    const mapCount = new Map(last7.map(d => [d, 0]));
    let weekCount = 0;
    let monthCount = 0;
    let monthRevenueValue = 0;

    for (const ap of arrForRole){
      if (mapCount.has(ap.data)){
        mapCount.set(ap.data, (mapCount.get(ap.data) || 0) + 1);
        weekCount++;
      }
      if (isoYearMonth(ap.data) === thisMonth){
        monthCount++;
        monthRevenueValue += getPrice(ap);
      }
    }

    weekTotal.textContent = String(weekCount);
    monthTotal.textContent = String(monthCount);
    allTotal.textContent = String(arrForRole.length);
    monthRev.textContent = formatBRL(monthRevenueValue);

    ensureChart(last7, last7.map(d => mapCount.get(d) || 0));

    // ===== lista =====
    lista.innerHTML = "";
    if (visible.length === 0){
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    for (const ap of visible){
      const card = document.createElement("div");
      card.className = "ap-card";

      const st = (ap.status || "pendente").toLowerCase() === "concluido" ? "concluido" : "pendente";
      const price = getPrice(ap);

      // Permiss√µes:
      // - Barbeiro: pode concluir/reabrir, n√£o pode remover
      // - Admin: pode concluir/reabrir e remover
      const canDelete = !!currentUser?.isAdmin;

      card.innerHTML = `
        <h4>${ap.nome || "Sem nome"}</h4>
        <div class="ap-meta">Barbeiro: <strong>${ap.barbeiro || "-"}</strong> ‚Ä¢ Data: <strong>${ap.data || "-"}</strong> ‚Ä¢ Hora: <strong>${ap.hora || "-"}</strong></div>
        <div class="ap-meta">Valor (estimado): <strong>${formatBRL(price)}</strong></div>

        <div class="ap-actions">
          <span class="status ${st}">${st}</span>
          <span style="flex:1"></span>
          ${
            st === "concluido"
              ? `<button class="btn btn-ghost" data-action="reabrir" data-id="${ap.id}">Reabrir</button>`
              : `<button class="btn btn-done" data-action="concluir" data-id="${ap.id}">Concluir</button>`
          }
          ${ canDelete ? `<button class="btn btn-danger" data-action="remover" data-id="${ap.id}">Remover</button>` : ``}
        </div>
      `;

      lista.appendChild(card);
    }

    lista.querySelectorAll("button[data-action]").forEach(btn => {
      btn.onclick = () => handleAction(btn.dataset.action, btn.dataset.id);
    });
  }

  async function handleAction(action, id){
    const r = ref(db, "agendamentos/" + id);

    if (action === "concluir") {
      await update(r, { status: "concluido" });
      return;
    }
    if (action === "reabrir") {
      await update(r, { status: "pendente" });
      return;
    }
    if (action === "remover") {
      if (!currentUser?.isAdmin) return;
      if (confirm("Remover agendamento?")) {
        await remove(r);
      }
      return;
    }
  }
</script>

</body>
</html>
